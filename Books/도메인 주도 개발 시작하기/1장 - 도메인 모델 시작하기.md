# 1장 - 도메인 모델 시작하기

### 1절 - 도메인이란?

소프트웨어로 해결하고자 하는 문제 영역

특징

1. 하나의 도메인은 다시 하위 도메인으로 나눌 수 있습니다.
2. 하나의 하위 도메인은 다른 하위 도메인과 연동하여 완전한 기능을 제공합니다.
3. 도메인 내의 모든 기능을 직접 구현하는 것은 아닙니다. (대신, 외부 시스템과 연동)
4. 하위 도메인을 어떻게 구성할지는 상황(요구사항)에 따라 달라집니다.

<br>

### 2절 도메인 전문가와 개발자 간 지식공유

각 도메인 전문가는 원하는 기능 개발을 개발자에게 요구합니다.

요구사항을 정확하게 이해하기 위해서는 개발자도 도메인 지식을 갖춰야합니다.

때때로, 도메인 전문가는 본인들이 실제로 원하는 것을 정확하게 표현하지 못할 때가 있습니다. 대화를 통해 진짜로 원하는 것을 찾아야합니다.

<br>

### 3절 도메인 모델

#### 도메인 모델

1. 도메인 모델은 특정 도메인을 개념적으로 표현하는 것입니다.

2. 도메인 모델은 전문가, 개발자를 포함한 관계자들이 도메인을 이해하고, 도메인 지식을 공유하는 데 도움을 줍니다.

3. 도메인 모델은 도메인 자체를 이해하기 위한 개념 모델이므로, 모델링을 하는 여러가지 표현방식이 있을 수 있습니다.
4. 4절에서는 도메인 계층을 구현할 때, 사용하는 객체 모델을 지칭합니다.

<br>

#### 개념 모델의 표현방식

1. 객체 기반 도메인 모델
2. 상태 다이어그램 이용한 도메인 모델
3. 수학공식을 활용한 도메인 모델

<br>

#### 개념모델과 구현 모델

개념 모델만으로는 구현할 수 없기 때문에 구현기술에 맞는 구현모델이 따로 필요합니다.

개념 모델의 특성에 맞게 구현 모델을 선택할 수 있습니다. (예시: 객체 모델을 개념모델로 사용했다면, 객체지향언어를 이용하여 개념모델에 가깝게 구현 가능)

<br>

### 4절 도메인 모델 패턴

도메인 모델 패턴은 아키텍처 상의 도메인 계층을 객체지향기법으로 구현하는 패턴을 의미합니다.

도메인 계층은 도메인의 핵심 규칙을 구현합니다.

즉, 도메인 규칙을 객체지향기법으로 구현하는 패턴입니다.

<br>

책에서는 주문 도메인의 배송지 변경가능 여부 메소드를 예시로 들고 있습니다.

중요한 것은 **배송지 변경가능 여부**와 같은 주문과 관련된 중요업무규칙을 도메인 모델에 구현하였다는 것입니다.

이렇게 구현할 경우, 중요업무규칙이 바뀌거나, 규칙을 확장해야될 때, 다른 코드에 영향을 덜 주게됩니다.

<br>

### 5절 도메인 모델 도출

#### 도메인을 이해하고, 도메인 모델 초안을 위해서 아래 항목들을 참고해야 합니다.

1. 기획서
2. 유스케이스
3. 사용자 스토리

<br>

#### 요구사항에서 도출해야되는 도메인 모델의 요소

1. 핵심 구성요소

2. 규칙

3. 기능

<br>

#### 각각의 요소는 아래와 같이 변환됩니다.

1. 핵심 구성요소 - 도메인 모델 객체
2. 규칙 - 객체 생성시, 제한사항을 나타내는 메소드
3. 기능 - 기능을 수행하는 메소드

<br>

### 6절 엔티티와 밸류

도출한 도메인 모델은 엔티티와 밸류로 구분됩니다.

#### 엔티티

1. 식별자를 가진다. (즉, 각 엔티티 객체는 고유합니다.)
2. 식별자는 생성, 수정, 삭제될 때까지 바뀌지 않습니다.
3. 식별자를 이용하여 eqauls(), hashCode() 메소드를 구현할 수 있습니다.

<br>

#### 엔티티의 식별자 생성방식

1. 특정규칙에 따라 생성

   주문번호의 경우, `20220410...` 의 형태처럼 **현재 날짜 + 고유한 값** 을 조합한 형태를 사용

   카드번호의 경우, 맨 앞 4자리는 각 카드사별로 구분되는 고유한 번호를 사용

2. UUID나 Nano ID 같이 Random한 고유식별자 생성기를 이용하여 생성

3. 값을 직접 입력

   회원 ID, 이메일의 경우, 회원이 입력한 값을 그대로 사용

4. 일련번호(sequence) 사용: 일반적으로 가장 많이 쓰이는 방식

   MySQL은 auto increment 기능을 사용: 테이블에 데이터를 삽입하기 전까지 식별자를 알 수 없음

   Oracle은 시퀀스를 이용해서 자동 증가 식별자를 구하는 방식을 사용

<br>

#### 밸류

하나의 완전한 도메인 개념을 표현하기 위해 사용되는 객체를 의미합니다.

밸류타입 사용 시, 장점

1. 의미를 가지게 되고, 이는 코드를 이해하는데 도움이 됩니다.

   단순히 price, amounts를 int 타입으로 표현할 때와는 달리, Money라는 밸류타입을 사용하면, 돈이라는 의미를 가지게 됩니다.

2. 밸류타입을 위한 기능을 추가할 수 있게 됩니다.

   물론, 밸류타입을 사용하지 않을 때에는 단순히 정수 타입 연산이었지만, 밸류타입에서는 돈 계산 이라는 의미를 가지게 됩니다.

<br>

밸류타입을 불변객체로 구현해야하는 이유

1. [참조투명성](https://ko.wikipedia.org/wiki/%EC%B0%B8%EC%A1%B0_%ED%88%AC%EB%AA%85%EC%84%B1)

   모든 프로그램 p에 대해 표현식 e의 모든 출현을 e의 평가로 치환해도 p의 의미에 아무 영향이 미치지 않는다면, 그 표현식 e는 참조에 투명하다. 만일 표현식 f(x)가 참조에 투명한 모든 x에 대해 참조에 투명하면, 함수 f는 순수하다

   이를 쉽게 말하면, 동일한 인자에 대해 동일한 값을 반환하는 것을 의미합니다.

   이것이 성립하기 위해서는, 함수 (또는 메쏘드) 가 **함수 외부의 영향을 받지 않아야 된다**는 것을 의미합니다.

   책에서의 예제를 들어보겠습니다.

   ```java
   public OrderLine getOrderLine1(Product product, int price, int quantity) {
       OrderLine line = new OrderLine(product, price, quantity);
   	return line;
   }
   
   public OrderLine getOrderLine2(Product product, int price, int quantity) {
       OrderLine line = new OrderLine(product, price, quantity);
       product.setValue(2000);
   	return line;
   }
   ```

   참조투명성 관점에서 `line`이라는 변수에 대한 표현식 e는 아래 코드를 의미합니다.

   `new OrderLine(product, price, quantity);`

   참조가 투명하다는 것은 동일한 product, price, quantity 값을 인자로 줬을 때, 위의 표현식 `new OrderLine(product, price, quantity)`는 항상 동일한 값을 반환한다는 것을 의미합니다.

   하지만, Product가 가변객체일 경우, getOrderLine1 메소드와 getOrderLine2 메소드의 반환 값은 다릅니다. `line` 이라는 변수에 대한 표현식 e는 동일한데도 말이죠.

   반대로, Product 객체가 불변객체일 경우, 표현식 e는 참조에 투명함이 성립됩니다.

2. [스레드에 안전함 (Thread-safe)](https://ko.wikipedia.org/wiki/%EC%8A%A4%EB%A0%88%EB%93%9C_%EC%95%88%EC%A0%84)

   여러 스레드가 동시에 가변객체에 접근하여 수정할 경우, 각 스레드에서 함수의 수행결과가 일관되지 않을 것입니다.

   불변객체가 수정되는 경우, 기존 참조가 아닌 새로운 참조 값을 반환하므로 여러 스레드에서 함수가 수행되도 수행결과가 일관적입니다.

Copy-On-Write (객체에 대해 변경작업 수행 시, 객체를 복제하여 반환) 기법을 사용하여 구현

 참고: https://ko.wikipedia.org/wiki/%EB%B6%88%EB%B3%80%EA%B0%9D%EC%B2%B4

<br>

#### 도메인 모델에 set 메소드 넣지 않기

1. set 메소드보다는 생성 시점에 필요한 필요한 데이터를 모두 전달받아 도메인 객체가 완전한 상태를 가지도록할 것
2. 필드 값을 변경 메소드가 필요할 경우, set 메소드 대신 도메인의 지식 및 의도를 표현하는 네이밍을 사용할 것

<br>

### 7절 도메인 용어와 유비쿼터스 언어

1. 모든 도메인 관계자에게 통용되는 언어를 사용할 것
2. 도메인 용어를 잘 표현하는 영단어를 찾기 위해 시간을 투자할 것

